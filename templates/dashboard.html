<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Expenzo</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='dashboard-styles.css') }}">
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script defer src="{{ url_for('static', filename='dashboard.js') }}"></script>
  <script defer src="{{ url_for('static', filename='components.js') }}"></script>
</head>
<body>
  {% include 'partials/navbar.html' %}
  
  <div class="dashboard-container">
    <!-- Sidebar -->
    <aside class="dashboard-sidebar">
      <div class="sidebar-brand">
        <h2>Expenzo</h2>
      </div>
      <nav class="sidebar-nav">
        <a href="{{ url_for('dashboard') }}" class="nav-item active">
          <i class='bx bx-home'></i>
          <span>Dashboard</span>
        </a>
        <a href="{{ url_for('cards_page') }}" class="nav-item">
          <i class='bx bx-credit-card'></i>
          <span>Cards</span>
        </a>
        <a href="{{ url_for('income_page') }}" class="nav-item">
          <i class='bx bx-money'></i>
          <span>Income</span>
        </a>
        <a href="{{ url_for('expense_page') }}" class="nav-item">
          <i class='bx bx-wallet'></i>
          <span>Expense</span>
        </a>
        <a href="{{ url_for('transactions_page') }}" class="nav-item">
          <i class='bx bx-history'></i>
          <span>Transactions</span>
        </a>
        <a href="{{ url_for('limits_page') }}" class="nav-item">
          <i class='bx bx-bar-chart-alt-2'></i>
          <span>Limits</span>
        </a>
        <a href="{{ url_for('subscriptions_page') }}" class="nav-item">
          <i class='bx bx-calendar-check'></i>
          <span>Subscriptions</span>
        </a>
        <a href="{{ url_for('visualization_page') }}" class="nav-item">
          <i class='bx bx-line-chart'></i>
          <span>Visualization</span>
        </a>
      </nav>
      <div class="sidebar-footer">
        <div class="user-profile">
          <i class='bx bx-user-circle'></i>
          <span>{{ user_name }}</span>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="dashboard-main">
      <!-- Top Bar -->
      <header class="dashboard-header">
        <h1>Dashboard</h1>
        <div class="header-actions">
          <i class='bx bx-search'></i>
          <i class='bx bx-bell'></i>
        </div>
      </header>

      <!-- Dashboard Grid -->
      <div class="dashboard-grid">
        <!-- Total Balance Card -->
        <div class="dashboard-card balance-card">
          <div class="card-header">
            <h3>Total Balance</h3>
          </div>
          <div class="balance-amount">₹{{ "%.2f"|format(balance|default(0)) }}</div>
            {% if total_income and total_income > 0 %}
            {% set earnings_pct = ((total_income - total_expense) / total_income * 100) if total_income and total_income > 0 else 0 %}
            <div class="balance-trend">
              <span class="trend-positive">
                <i class='bx bx-trending-up'></i>
                Earnings +{{ "%.2f"|format(earnings_pct|default(0)) }}%
              </span>
            </div>
            {% endif %}
          <div class="balance-chart">
            <canvas id="balanceChart"></canvas>
          </div>
        </div>

        <!-- Top Spending Card -->
        <div class="dashboard-card spending-card">
          <div class="card-header">
            <h3>Top Spending</h3>
          </div>
          <div class="spending-amount">₹{{ "%.2f"|format(total_expense) }}</div>
          <div class="spending-chart">
            <canvas id="spendingChart"></canvas>
          </div>
          <div class="spending-legend">
            {% if category_spending %}
              {% for category, amount in category_spending.items() %}
              {% set colors = ['#4A90E2', '#7B68EE', '#FF6B9D', '#95A5A6', '#F39C12', '#E74C3C'] %}
              {% set color_index = loop.index0 % colors|length %}
              <div class="legend-item">
                <span class="legend-dot" data-color="{{ colors[color_index] }}"></span>
                <span>{{ category }} (₹{{ "%.2f"|format(amount) }})</span>
              </div>
              {% endfor %}
            {% else %}
            <p>No spending data</p>
            {% endif %}
          </div>
        </div>

        <!-- Cards Card -->
        <div class="dashboard-card cards-preview-card">
          <div class="card-header">
            <h3>Cards</h3>
            <a href="{{ url_for('cards_page') }}" class="view-all-link">View All</a>
          </div>
          <div class="cards-preview">
            {% if cards %}
              {% for card in cards[:2] %}
              <div class="preview-card-item">
                <div class="card-brand">{{ card.get('brand', 'Card') }}</div>
                <div class="card-number">{{ card.get('masked_number', '**** **** **** ' + card.get('last4', '----')) }}</div>
                <div class="card-holder">{{ card.get('cardholder', 'Card Holder') }}</div>
              </div>
              {% endfor %}
            {% else %}
            <p class="empty-state">No cards added</p>
            {% endif %}
          </div>
          <a href="{{ url_for('cards_page') }}" class="card-action-btn">Manage Cards</a>
        </div>

        <!-- Budget Card -->
        <div class="dashboard-card budget-card">
          <div class="card-header">
            <h3>Budget</h3>
            <select class="time-selector" id="budgetPeriod">
              <option value="week">Week</option>
              <option value="month" selected>Month</option>
            </select>
          </div>
          <div class="budget-chart">
            <canvas id="budgetChart"></canvas>
          </div>
          {% if user_limit and user_limit.get('limit') %}
          <div class="budget-info">
            <span>Limit: ₹{{ "%.2f"|format(user_limit.get('limit', 0)) }}</span>
            <span>Spent: ₹{{ "%.2f"|format(total_expense) }}</span>
          </div>
          {% else %}
          <div class="budget-info">
            <span>No limit set</span>
            <span>Spent: ₹{{ "%.2f"|format(total_expense) }}</span>
          </div>
          {% endif %}
        </div>

        <!-- Transaction History Card -->
        <div class="dashboard-card transactions-card">
          <div class="card-header">
            <h3>Transaction History</h3>
            <a href="{{ url_for('transactions_page') }}" class="view-all-link">View All</a>
          </div>
          <div class="transaction-filters">
            <button class="filter-btn active" data-filter="all">All</button>
            <button class="filter-btn" data-filter="income">Income</button>
            <button class="filter-btn" data-filter="expense">Spending</button>
          </div>
          <div class="transactions-list">
            {% if recent_transactions %}
              {% for tx in recent_transactions[:5] %}
              <div class="transaction-item" data-type="{{ tx.get('type', '') }}">
                <div class="transaction-icon">
                  {% if tx.get('type') == 'income' %}
                  <i class='bx bx-trending-up'></i>
                  {% else %}
                  <i class='bx bx-trending-down'></i>
                  {% endif %}
                </div>
                <div class="transaction-details">
                  <div class="transaction-title">{{ tx.get('category') or tx.get('source') or tx.get('payee') or 'Transaction' }}</div>
                  <div class="transaction-date">{{ tx.get('date', '')[:10] if tx.get('date') else 'N/A' }}</div>
                </div>
                <div class="transaction-amount {% if tx.get('type') == 'expense' %}negative{% else %}positive{% endif %}">
                  {% if tx.get('type') == 'expense' %}-{% else %}+{% endif %}₹{{ "%.2f"|format(tx.get('amount', 0)) }}
                </div>
              </div>
              {% endfor %}
            {% else %}
            <p class="empty-state">No transactions yet</p>
            {% endif %}
          </div>
        </div>

        <!-- Subscriptions Card -->
        <div class="dashboard-card subscriptions-card">
          <div class="card-header">
            <h3>Upcoming Subscriptions</h3>
            <a href="{{ url_for('subscriptions_page') }}" class="view-all-link">View All</a>
          </div>
          <div class="subscriptions-list">
            {% if subscriptions %}
              {% for sub in subscriptions[:4] %}
              <div class="subscription-item">
                <div class="subscription-name">{{ sub.get('name', 'Subscription') }}</div>
                <div class="subscription-amount">₹{{ "%.2f"|format(sub.get('amount', 0)) }}</div>
                <div class="subscription-date">Next: {{ sub.get('next_payment_date', 'N/A') }}</div>
              </div>
              {% endfor %}
            {% else %}
            <p class="empty-state">No active subscriptions</p>
            {% endif %}
          </div>
          <a href="{{ url_for('subscriptions_page') }}" class="card-action-btn">Manage Subscriptions</a>
        </div>

        <!-- Transaction Overview Card -->
        <div class="dashboard-card overview-card">
          <div class="card-header">
            <h3>Transaction Overview</h3>
          </div>
          <div class="overview-stats">
            <div class="stat-item">
              <span class="stat-label">Transactions</span>
              <span class="stat-value">{{ (recent_transactions|default([]))|length }}+</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Success Rate</span>
              <span class="stat-value">100%</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Total Income</span>
              <span class="stat-value">₹{{ "%.2f"|format(total_income) }}</span>
            </div>
          </div>
          <div class="overview-chart">
            <canvas id="overviewChart"></canvas>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script type="application/json" id="dashboard-data">
    {
      "totalIncome": {{ total_income|default(0) }},
      "totalExpense": {{ total_expense|default(0) }},
      "balance": {{ balance|default(0) }},
      "categorySpending": {{ (category_spending|default({}))|tojson|safe }},
      "recentTransactions": {{ (recent_transactions|default([]))|tojson|safe }}
    }
  </script>
  <script>
    // Pass data to JavaScript
    (function() {
      var dataScript = document.getElementById('dashboard-data');
      if (dataScript) {
        window.dashboardData = JSON.parse(dataScript.textContent);
      }
    })();
    
    // Apply legend dot colors
    document.addEventListener('DOMContentLoaded', function() {
      var legendDots = document.querySelectorAll('.legend-dot[data-color]');
      legendDots.forEach(function(dot) {
        dot.style.backgroundColor = dot.getAttribute('data-color');
      });
    });
  </script>
</body>
</html>
